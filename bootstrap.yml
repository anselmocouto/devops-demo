name: Bootstrap repository

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Criar diretórios e arquivos iniciais
        run: |
          mkdir -p src tests .github/workflows

          cat > src/calculator.py << 'PY'
          def add(a, b):
              return a + b

          def subtract(a, b):
              return a - b

          def multiply(a, b):
              return a * b

          def divide(a, b):
              if b == 0:
                  raise ValueError("Divisão por zero não permitida.")
              return a / b
          PY

          cat > tests/test_calculator.py << 'PYT'
          import pytest
          from src.calculator import add, subtract, multiply, divide

          def test_add():
              assert add(2, 3) == 5

          def test_subtract():
              assert subtract(5, 2) == 3

          def test_multiply():
              assert multiply(3, 4) == 12

          def test_divide():
              assert divide(10, 2) == 5

          def test_divide_by_zero():
              with pytest.raises(ValueError):
                  divide(10, 0)
          PYT

          cat > requirements.txt << 'REQ'
          pytest
          REQ

          cat > .github/workflows/ci-python.yml << 'CIY'
          name: CI - Python Demo

          on:
            push:
              branches: [ "main" ]
            pull_request:
              branches: [ "main" ]
            workflow_dispatch:

          jobs:
            build:
              runs-on: ubuntu-latest
              steps:
                - name: Checkout do código
                  uses: actions/checkout@v4

                - name: Configurar Python
                  uses: actions/setup-python@v5
                  with:
                    python-version: "3.11"

                - name: Instalar dependências
                  run: |
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt

                - name: Rodar testes
                  run: pytest -v
          CIY

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Bootstrap: estrutura do projeto + CI" || echo "Sem alterações para commitar"
          git push origin HEAD:main
